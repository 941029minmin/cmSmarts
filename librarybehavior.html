<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>图书馆行为分析</title>
		<link rel="stylesheet" href="./css/style.css" />
		<link rel="stylesheet" href="./css/main.css" />
		<link rel="stylesheet" href="./js/layui/css/layui.css" />
		<style>
			.main-right .job-top-list ul li {
				width: 16.6%;
				position: relative;
			}
			input{
	        	color: #dfdfdf;
	        	padding-left: 20px;
	        }
	        /*分页*/
			#paging{
				float: left;
				margin-top: 20px;
			}
			#EXCha_4,#EXCha_5,#EXCha_6,#EXCha_7{
				width: 100%;
			    height: 380px;
			    margin: 0 auto;
			    margin-top: 0px;
			}
			header .header-logo {
			    height: 100px;
			    width:365px;
			    margin: 0 auto;
			}
			header .header-logo h1 span {
			    color: #feffff;
			    font-size: 26px;
			    font-family: PingFangMedium;
			    font-weight: normal;
			    line-height: 80px;
			    padding-left: 10px;
			}
			#EXCha_2,#EXCha_3{
				width: 100%
			}
			header .goPage a{
				color: #03AFB8;
				float: right;
				font-weight: 600;
				font-size: 16px;
			    margin-top: -70px;
			    margin-right: 50px; 
			}
			header .goPage a:hover{
				color: #eee;
			}
		</style>
	</head>
	<body>
		<!--网页头部-->
		<div class="header-top">
			<header>
				<div class="header-logo">
					<h1>
						<img src="./img/logo.png" /><span>曙光智慧校园大数据系统</span>
					</h1>
				</div>
				<div class="goPage"><a href="index.html">→&nbsp;学生群体画像分析</a></div>
			</header>
		</div>

		<div class="main">
			<div class="main-right">
				<div class="top-list canteen-top-list job-top-list">
					<ul>
						<li>
							<select name="college" id="college" autocomplete="off">
								<option value="" disabled selected>学院</option>
							</select>
						</li>
						<li>
							<select name="zhuanye" id="major" autocomplete="off">
								<option value="" disabled selected>专业</option>
							</select>
						</li>
						<li>
							<select name="end-time" id="grade" autocomplete="off">
								<option value="" disabled selected>年级</option>
							</select>
						</li>
						<li>
							<input id="starttime" value="开始时间" title="请选择开始时间!" />
						</li>
						<li>
							<input id="endtime" value="结束时间" title="请选择结束时间!" />
						</li>
						<li class="result">
							<a id="submit" href="javascript:;"><i class="search"></i>查询结果</a>
						</li>
					</ul>
				</div>
				
				<div class="top-list">
					<ul>
						<li><img src="./img/rjjycs.png" /><span>人均借阅书次</span><span id = "LendBookCounts">546</span><img class="xian" src="./img/fgx.png"/></li>
						<li><img src="./img/tsjycs.png" /><span>图书借阅人次</span><span id = 'LendCount'>324</span><img class="xian" src="./img/fgx.png"/></li>
						<li><img src="./img/pjjysc.png" /><span>平均借阅时长</span><span id = 'LendTimes'>345</span></li>
					</ul>
				</div>
				<h1>馆藏利用</h1>
				<div class="echarts-list">
					
					<div class="listtwo librarytwo">
						<ul>
							<li>
								<h2>最受欢迎图书</h2>
								<div id="EXCha_2"></div>
								<p class="butp">借阅次数</p>
							</li>
							<li>
								<h2>平均借阅时长</h2>
								<div id="EXCha_3" style = "margin-top: -45px"></div>
								<p class="butp">借阅天数</p>
							</li>
						</ul>
					</div>
				</div>
				<h1>学生借阅分析</h1>
				<div class="echarts-list">
					<div class="listtwo librarytwo">
						<ul>
							<li style = "width: 33%">
								<h2>学生借阅对比</h2>
								<div id="EXCha_4"></div>
							</li>
							<li style = "width: 66%">
								<h2>学生借阅分析</h2>
								<div id="EXCha_5" style = "margin-top: -45px;"></div>
							</li>
						</ul>
					</div>
				</div>
				<div class="clear"></div>
				<footer>版权所有 © 2018 浙江曙光信息技术有限公司</footer>
			</div>
		</div>
		<!--弹窗详情-->
		<div class="stu_popup">
			<section>
				<div id = 'close' style ='float: right;margin-right: 3%;color:#FFFFFF;margin-top: 10px;font-size: 20px;cursor: pointer;' >X</div>
				<h1 id = "mockid">详情 </h1>
				<div class="popup_table">
					<div class="popup_table_list">
						<table class="">
						    <thead id = "thead">
						    	
						    </thead>
						    <tbody id = 'newTeacherList'>
				
						    </tbody>
						  </table>
						  <div id="paging"></div>
						  <!-- <img id="download" title="点击下载" src="../img/xz.png" /> -->
						  <div class="clear"></div>
					</div>
				</div>
			</section>
		</div>
		<script type="text/javascript" src="./js/jquery.min.js" ></script>
		<script type="text/javascript" src="./js/echarts.js" ></script>
		<script type="text/javascript" src="./js/basic.js" ></script>
		<script type="text/javascript" src="./js/laydate/laydate.js" ></script>
		<script type="text/javascript" src="./js/layui/layui.js" ></script>

		<script>
			//layer时间选择器
			laydate.render({
			  elem: '#starttime' 
			});
			laydate.render({
			  elem: '#endtime' 
			});
			var myDate = new Date;
    		var year = myDate.getFullYear();//获取当前年
    		var yue = myDate.getMonth()+1;//获取当前月
    		var date = myDate.getDate();//获取当前日
			function getBeforeDate(n) {
		        var n = n;
		        var d = new Date();
		        var year = d.getFullYear();
		        var mon = d.getMonth() + 1;
		        var day = d.getDate();
		        if(day <= n) {
		            if(mon > 1) {
		                mon = mon - 1;
		            } else {
		                year = year - 1;
		                mon = 12;
		            }
		        }
		        d.setDate(d.getDate() - n);
		        year = d.getFullYear();
		        mon = d.getMonth() + 1;
		        day = d.getDate();
		        s = year + "-" + (mon < 10 ? ('0' + mon) : mon) + "-" + (day < 10 ? ('0' + day) : day);
		        return s;
		    }
		    $("#starttime").val(getBeforeDate(60));
		    $("#endtime").val(getBeforeDate(0));
			
			//请求接口
			var ip_addr = getUrl();
			var pageNo = 1;
			$(document).ready(function() {
				var bodyw = document.body.clientWidth;
				$(".stu_popup section").css("margin-left",bodyw/2-400); 
				$("#close").click(function(){
					$(".stu_popup").hide();
					$("#newTeacherList").html("");

				});
				var xym = $("#college").val();//学院id
				var zym = $("#major").val();//专业id
				var bm = $("#grade").val();//年级id
				var beginTime = $("#starttime").val()+"T00:00:00.000Z";//开始时间
				var endTime = $("#endtime").val()+"T00:00:00.000Z";//结束时间

				getSelectXym();//学院
				getAvgLendBookCounts(xym,zym,bm,beginTime,endTime)//总数
				getLendBookRank(xym,zym,bm,beginTime,endTime);//喜欢
				getBorrowingTime(xym,zym,bm,beginTime,endTime);//时长
				getStudentBorrow(xym,zym,bm,beginTime,endTime);//学生借阅
			})
			 
			//点击提交
			$("#submit").click(function(){
				var xym = $("#college").val();//学院id
				var zym = $("#major").val();//专业id
				var bm = $("#grade").val();//年级id
				var beginTime = $("#starttime").val()+"T00:00:00.000Z";//开始时间
				var endTime = $("#endtime").val()+"T00:00:00.000Z";//结束时间
				getAvgLendBookCounts(xym,zym,bm,beginTime,endTime)//总数
				getLendBookRank(xym,zym,bm,beginTime,endTime);//喜欢
				getBorrowingTime(xym,zym,bm,beginTime,endTime);//时长
				getStudentBorrow(xym,zym,bm,beginTime,endTime);//学生借阅
			})
			
			//获取学院
			function getSelectXym(){
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getSelectXym', 
					data: {
						
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {	
							for (var i = 0; i < result.length; i++) {
								innerHTML +='<option class='+ result[i] +' value='+ result[i] +'>'+ result[i] +'</option>';
	               			};
							$("#college").append(innerHTML);
							$("#college").unbind("change").change(function(){
								var college = $('#college option:selected').attr('class');
								getSelectZhuanye(college)//专业
							});
						} else{
							alert(data.msg)
						}
					}
				});
			};
			//获取专业
			function getSelectZhuanye(college){
				document.getElementById("major").innerHTML = "";
				$("#major").html('<option value="" disabled selected>专业</option>');
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getSelectZhuanye', 
					data: {
						xym:college,
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {	
							for (var i = 0; i < result.length; i++) {
								innerHTML +='<option class='+result[i]+' value='+result[i]+'>'+result[i]+'</option>';
	               			};
							$("#major").append(innerHTML);
							$("#major").unbind("change").change(function(){
								var major = $('#major option:selected').attr('class');
								getSelectNianji(college,major)//获取年级
							});
							
						} else{
							alert(data.msg)
						}
					}
				});
			};
			//获取年级
			function getSelectNianji(college,major){
				document.getElementById("grade").innerHTML = "";
				$("#grade").html('<option value="" disabled selected>年级</option>');
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getSelectNianji', 
					data: {
						xym:college,
						zym:major
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {	
							for (var i = 0; i < result.length; i++) {
								innerHTML +='<option class='+result[i]+' value='+result[i]+'>'+result[i]+'</option>';
	               			};
							$("#grade").append(innerHTML);
						} else{
							alert(data.msg)
						}
					}
				});
			};
			//获取总数
			function getAvgLendBookCounts(xym,zym,bm,beginTime,endTime){
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getAvgLendBookCounts', 
					data: {
						xym:xym,
						zym:zym,
						bm:bm,
						start_time:beginTime,
						end_time:endTime
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {
							$("#LendBookCounts").text(result.avgRate);
							$("#LendCount").text(result.lendCount);
							$("#LendTimes").text(result.avg_time);
							
						} else{
							alert(data.msg)
						}
					}
				});
			};
			//最受欢迎图书
			function getLendBookRank(xym,zym,bm,beginTime,endTime){
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getLendBookRank', 
					data: {
						xym:xym,
						zym:zym,
						bm:bm,
						start_time:beginTime,
						end_time:endTime
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {	
							var ArrData = new Array();
							var ArrName = new Array();
							for (var i=result.data.length-1;i>=0;i--) {
			                	ArrData.push(result.data[i]);
			           		};
							for (var i=result.categories.length-1;i>=0;i--) {
			                	ArrName.push(result.categories[i]);
			           		};
							var myChart2 = echarts.init(document.getElementById('EXCha_2'));
							option2 = {
							    tooltip : {
							        trigger: 'axis',
							        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
							            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
							        }
							    },
							    grid: {
							        left: '3%',
							        right: '4%',
							        bottom: '4%',
							        containLabel: true
							    },
							    xAxis:  {
							        type: 'value',
							        splitLine: {
									    lineStyle: {
									        color: ['#222b73']
									    }
									},
									axisLabel:{
										formatter: '{value}次',
										textStyle: {
											color:"#dfdfdf"
										}
										
									}
							    },
							    yAxis: {
							        type: 'category',
							        data: ArrName,
							        axisLabel:{
										textStyle: {
											color:"#dfdfdf"
										}
										
									}
							    },
							    series: [
							        {
							            name: '借阅次数TOP20',
							            type: 'bar',
							            stack: '总量',
							            barWidth: '10',
							            label: {
							                normal: {
							                    show: true,
							                    position: 'right',
							                    textStyle: {
							                    	color:'#dfdfdf'
							                    }			                
							                }
							            },
							            data: ArrData,
							            itemStyle: {
							                normal: {
							                    color: new echarts.graphic.LinearGradient(
							                        1, 0, 0, 0,
							                        [
							                            {offset: 0, color: '#3ee593'},
							                            {offset: 1, color: '#3ab2b6'}
							                        ]
							                    ),
							                     barBorderRadius: [0, 10, 10, 0]
							                }
							            },
							        }
							    ]
							};
							myChart2.setOption(option2);
							myChart2.on('click', function (param) {
								bookName = param.name;
								pageNo = 1;
								getLendBookRankDetail(xym,zym,bm,beginTime,endTime,bookName)
							});
						} else{
							alert(data.msg)
						}
					}
				});
			};
			//列表1
			function getLendBookRankDetail(xym,zym,bm,beginTime,endTime,bookName){
				$(".stu_popup").show();
				document.getElementById("mockid").innerHTML = "借阅详情";
				document.getElementById("thead").innerHTML = " <tr><th>学号</th><th>姓名</th><th>专业</th><th>借书日期</th><th>还书日期</th></tr> ";
				document.getElementById("newTeacherList").innerHTML = "";
				layui.use('laypage', function(){
					var laypage = layui.laypage
					,layer = layui.layer;
					var innerHTML = "";
					$.ajax({
						type: 'post',
						dataType: 'json', 
						url: ip_addr + 'student/getLendBookRankDetail', 
						data: {
							xym:xym,
							zym:zym,
							bm:bm,
							bookName:bookName,
							start_time:beginTime,
							end_time:endTime,
							pageNo:pageNo,
							pageNum:6
						},
						success: function(data) { 
							var result = data.result.data;
							var innerHTML = '';
							if(data.success == true) {
								for (var i = 0; i < result.length; i++) {
									innerHTML +='<tr>';
							        innerHTML +='<td>'+result[i].xh+'</td>';
							        innerHTML +='<td>'+result[i].xm+'</td>';
							        innerHTML +='<td>'+result[i].zym+'</td>';
							        innerHTML +='<td>'+result[i].jyrq+'</td>';
							        innerHTML +='<td>'+result[i].ghrq+'</td>';
							     	innerHTML +='</tr>';	
			           			};	
			           			$("#newTeacherList").append(innerHTML);
								  //分页
								  laypage.render({
								    elem: 'paging'
								    ,curr: pageNo
								    ,limit:6
								    ,count: data.result.count 
								    ,layout: ['count', 'prev', 'page', 'next']
								    ,jump: function(obj,first) { //触发分页后的回调
											if(!first) { //点击跳页触发函数自身，并传递当前页：obj.curr
												pageNo = obj.curr;
												getLendBookRankDetail(xym,zym,bm,beginTime,endTime,bookName);
												
											}
										}
								  });
								
							} else{
								alert(data.msg)
							}
						}
					});
				});
			}	
			//平均借阅时长
			function getBorrowingTime(xym,zym,bm,beginTime,endTime){
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getBorrowingTime', 
					data: {
						xym:xym,
						zym:zym,
						bm:bm,
						start_time:beginTime,
						end_time:endTime
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {
							var ArrData = new Array();
							var ArrName = new Array();
							for (var i=result.data.length-1;i>=0;i--) {
			                	ArrData.push(result.data[i]);
			           		};
							for (var i=result.categories.length-1;i>=0;i--) {
			                	ArrName.push(result.categories[i]);
			           		};
							var myChart3 = echarts.init(document.getElementById('EXCha_3'));
							option3 = {
							    tooltip : {
							        trigger: 'axis',
							        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
							            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
							        }
							    },
							    grid: {
							        left: '3%',
							        right: '4%',
							        bottom: '4%',
							        containLabel: true
							    },
							    xAxis:  {
							        type: 'value',
							        splitLine: {
									    lineStyle: {
									        color: ['#222b73']
									    }
									},
									axisLabel:{
										formatter: '{value}天',
										textStyle: {
											color:"#dfdfdf"
										}
										
									}
							    },
							    yAxis: {
							        type: 'category',
							        data: ArrName,
							        axisLabel:{
										textStyle: {
											color:"#dfdfdf"
										}
										
									}
							    },
							    series: [
							        {
							            name: '平均借阅时长',
							            type: 'bar',
							            stack: '总量',
							            barWidth: '10',
							            cursor:'default',
							            label: {
							                normal: {
							                    show: true,
							                    position: 'right',
							                    textStyle: {
							                    	color:'#dfdfdf'
							                    }			                
							                }
							            },
							            data: ArrData,
							            itemStyle: {
							                normal: {
							                    color: new echarts.graphic.LinearGradient(
							                        1, 0, 0, 0,
							                        [
							                            {offset: 0, color: '#6192ff'},
							                            {offset: 1, color: '#23459e'}
							                        ]
							                    ),
							                     barBorderRadius: [0, 10, 10, 0]
							                }
							            },
							        }
							    ]
							};
							myChart3.setOption(option3);
							myChart3.on('click', function (param) {
								conditionName = param.name;
								pageNo = 1;
								getBorrowingTimeDetail(xym,zym,bm,beginTime,endTime,conditionName)
							});
						} else{
							alert(data.msg)
						}
					}
				});
				
			};
			//列表2
			function getBorrowingTimeDetail(xym,zym,bm,beginTime,endTime,conditionName){
				$(".stu_popup").show();
				document.getElementById("mockid").innerHTML = "借阅详情";
				document.getElementById("thead").innerHTML = " <tr><th>学号</th><th>姓名</th><th>学院</th><th>专业</th><th>平均借阅时长</th></tr> ";
				document.getElementById("newTeacherList").innerHTML = "";
				layui.use('laypage', function(){
					var laypage = layui.laypage
					,layer = layui.layer;
					var innerHTML = "";
					$.ajax({
						type: 'post',
						dataType: 'json', 
						url: ip_addr + 'student/getBorrowingTimeDetail', 
						data: {
							xym:xym,
							zym:zym,
							bm:bm,
							conditionName:conditionName,
							start_time:beginTime,
							end_time:endTime,
							pageNo:pageNo,
							pageNum:6
						},
						success: function(data) { 
							var result = data.result.data;
							var innerHTML = '';
							if(data.success == true) {
								for (var i = 0; i < result.length; i++) {
									innerHTML +='<tr>';
							        innerHTML +='<td>'+result[i].xh+'</td>';
							        innerHTML +='<td>'+result[i].xm+'</td>';
							        innerHTML +='<td>'+result[i].xym+'</td>';
							        innerHTML +='<td>'+result[i].zym+'</td>';
							        innerHTML +='<td>'+result[i].num+'</td>';
							     	innerHTML +='</tr>';	
			           			};	
			           			$("#newTeacherList").append(innerHTML);
								  //分页
								  laypage.render({
								    elem: 'paging'
								    ,curr: pageNo
								    ,limit:6
								    ,count: data.result.count 
								    ,layout: ['count', 'prev', 'page', 'next']
								    ,jump: function(obj,first) { //触发分页后的回调
											if(!first) { //点击跳页触发函数自身，并传递当前页：obj.curr
												pageNo = obj.curr;
												getBorrowingTimeDetail(xym,zym,bm,beginTime,endTime,conditionName);
											}
										}
								  });
							} else{
								alert(data.msg)
							}
						}
					});
				});
       
			}	
			//学生借阅分析
			function getStudentBorrow(xym,zym,bm,beginTime,endTime){
				$.ajax({
					type: 'post',
					dataType: 'json', 
					url: ip_addr + 'student/getStudentBorrow', 
					data: {
						xym:xym,
						zym:zym,
						bm:bm,
						start_time:beginTime,
						end_time:endTime
					},
					success: function(data) { 
						var result = data.result;
						var innerHTML = '';
						if(data.success == true) {
							var datalen = result.data[0].data;
							var piearr = [],pielegend = [],bararr = [],barlegend = [];
							for(var i = 0;i < result.data.length;i++){
								pielegend.push(result.data[i].name);
								barlegend.push(result.data[i].name);
								var pieobj = {
									name:result.data[i].name,
									type: 'pie',
									value:result.data[i].y
								}
								piearr.push(pieobj)
								var barobj = {
									name:result.data[i].name,
									type:'bar',
									data:result.data[i].data
								}
								bararr.push(barobj)

							}
							barlegend.push("借阅率");
							var lineobj = {
								name:'借阅率',
					            type:'line',
					            data:result.line,
					            yAxisIndex: 1,
					            itemStyle :{
					            	normal: {
										color: 'pink'
									},
					            }
							}
							bararr.push(lineobj)
							var colors = ['#29c7d2','#d67983'];


							var myChart4 = echarts.init(document.getElementById('EXCha_4'));
							option4 = {
							    tooltip : {
							        trigger: 'item',
							        formatter: "{a} <br/>{b} : {c} ({d}%)"
							    },
							    color:colors,
							    legend: {
							        orient: 'vertical',
							        data:pielegend,
					                textStyle:{
					                	color:"#dfdfdf"
					                },
					                height:"0",
					                top:"300"
							    },
							    series : [
							        {
							            name: '学生借阅分析',
							            type: 'pie',
							            radius : '55%',
							            center: ['50%', '38%'],
							            cursor:'default',
							            labelLine:{
							            	normal:{
							            		show:true,
							            		length:5
							            	}
							            },
							            label: {
							                normal: {
							                    show: true,
							                    position:"inside",
							                    formatter: '{d}%',
							                }
							            },
							            data:piearr,
							            itemStyle: {
							                emphasis: {
							                    shadowBlur: 10,
							                    shadowOffsetX: 0,
							                    shadowColor: 'rgba(0, 0, 0, 0.5)'
							                }
							            }
							        }
							    ]
							};
							myChart4.setOption(option4);
							var myChart5 = echarts.init(document.getElementById('EXCha_5'));
							option5 = {
								color: colors,
							    tooltip : {
							        trigger: 'axis',
							        axisPointer : {            
							            type : 'shadow'        
							        }
							    },
							    legend: {
							        data:barlegend,
							        textStyle: {
										color: '#dfdfdf',
										fontSize: 14
									},
									top: "95%"
							    },
							    grid: {
							        left: '3%',
							        right: '4%',
							        bottom: '20%',
							        containLabel: true
							    },
							    xAxis : [
							        {
							            type : 'category',
							            data : result.categories,
							            axisLabel:{
											interval: 0,
				             				rotate: 30,
											textStyle: {
												color:"#dfdfdf"
											}
											
										}
							        }
							    ],
							    yAxis : [
							        {
							            type : 'value',
							            nameTextStyle:{
							              color:"#dfdfdf",
							            },
										axisLabel: {
							                textStyle: {
												color:"#dfdfdf"
											}
							            },
										splitLine: {
										    lineStyle: {
										        color: ['#222b73']
										    }
										}
							        },
							        {
									type: 'value',
									nameLocation: 'middle',
									nameTextStyle: {
										color: "#fff",
									},
									nameGap: 50,
									
									axisLabel: {
										formatter: '{value}',
										textStyle: {
											color: '#dfdfdf',
											fontSize: 14
										},
									},
									axisLine: {
										show: false
									},
									splitLine: {
										show: true,
										lineStyle: {
											color: "#222b73",
											type: 'solid'
										}
									}
								}
							    ],
							    series : bararr
							};
							myChart5.setOption(option5);
						} else{
							alert(data.msg)
						}
					}
				});
			};
		</script>
	</body>
</html>
